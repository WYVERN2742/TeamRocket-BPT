<!doctype html>
<html lang="en">

<head>
	<title>Procurement | Homepage</title>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/style.css">

	<!-- FontAwesome CSS (icons) -->
	<link rel="stylesheet" href="css/fontawesome.min.css">
</head>

<body>
	<!-- Site Header -->
	<header>
		<nav class="navbar navbar-static-top navbar-default navbar-expand-md shadow navbar-dark bg-dark">
			<a href="index.html"><img src="img/bangor_logo_c2_flush.svg" alt="Bangor University",
					height="50em"></a>
			<button class="navbar-toggler d-lg-none" type="button" data-toggle="collapse" data-target="#navBar"
				aria-controls="navBar" aria-expanded="false" aria-label="Toggle navigation"></button>
			<div class="collapse navbar-collapse" id="navBar">
				<ul class="navbar-nav mr-auto mt-2 mt-lg-0">
					<li class="nav-item active">
						<a class="nav-link" href="index.html"><i class="fa fa-home" aria-hidden="true"></i> Homepage <span class="sr-only">(current)</span></a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="makerequest.html"><i class="fa fa-pen-fancy" aria-hidden="true"></i> Make Request</a>
					</li>
					<li class="nav-item dropdown">
						<a class="nav-link dropdown-toggle" href="#" id="dropdownAdmin" data-toggle="dropdown"
							aria-haspopup="true" aria-expanded="false"> <i class="fa fa-wrench" aria-hidden="true"></i>Admin</a>
						<div class="dropdown-menu" aria-labelledby="dropdownAdmin">
							<a class="dropdown-item" href="#"><i class="fa fa-user" aria-hidden="true"></i> Edit Users</a>
							<a class="dropdown-item" href="#"><i class="fa fa-wrench" aria-hidden="true"></i> Edit BudgetCodes</a>
						</div>
					</li>
				</ul>
				<form class="form-inline my-2 my-lg-0">
					<!-- Trigger logout modal -->
					<button class="btn btn-outline-danger my-2 my-sm-0" type="button" , data-toggle="modal" ,
						data-target="#modelLogout"><i class="fa fa-door-closed"></i>Logout</button>
				</form>
			</div>
		</nav>
		<div class="modal fade" id="modelLogout" tabindex="-1" role="dialog" aria-labelledby="modelTitleId"
			aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Logging out?</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						You are about to log out, are you sure? <br> You will need to log in again to continue using the
						site.
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal"><i class="fa fa-times "></i> Cancel</button>
						<form id="do_logout">
							<button type="submit" class="btn btn-danger"><i class="fa fa-door-closed"></i>Logout</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	</header>
	<!-- Page Content-->
	<main role="main" class="col-md-12 ml-sm-auto col-lg-12 px-4 container-fluid">
		<div class="row">
			<div class="col-lg-4">
				<div class="row">
					<div class="col">
						<div class="card text-white bg-primary">
							<div class="card-body">
								<div class="row">
									<div class="col-7">
										<h4 class="display-4">Pending</br> Requests</h4>
									</div>
									<div class="col-5">
										<p class="display-1" id="pending_requests">0</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col">
						<table class="table table-bordered table-hover table-responsive-md text-center">
							<thead class="thead-dark">
								<tr>
									<th>Drafts</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td>
										<div class="btn-block btn-group btn-group-justified" role="group"
											aria-label="Draft #1">
											<button type="button" class="btn btn-outline-primary btn-lg btn-block">Draft
												#1</button>
											<button type="button" class="btn btn-danger"><i class="fa fa-trash"
													aria-hidden="true"></i></button>
										</div>
									</td>
								</tr>
								<tr>
									<td>
										<div class="btn-block btn-group btn-group-justified" role="group"
											aria-label="Draft #2">
											<button type="button" class="btn btn-outline-primary btn-lg btn-block">Draft
												#2</button>
											<button type="button" class="btn btn-danger"><i class="fa fa-trash"
													aria-hidden="true"></i></button>
										</div>
									</td>
								</tr>
								<tr>
									<td>
										<div class="btn-block btn-group btn-group-justified" role="group"
											aria-label="Draft #3">
											<button type="button" class="btn btn-outline-primary btn-lg btn-block">Draft
												#3</button>
											<button type="button" class="btn btn-danger"><i class="fa fa-trash"
													aria-hidden="true"></i></button>
										</div>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="col-lg-8">
				<div class="row">
					<div class="col container-fluid">
						<h1>Requests</h1>
					</div>
					<div class="col">
						<div class="input-group">
							<input type="text" class="form-control" id="search" placeholder="Search"
								aria-label="Recipient's username" aria-describedby="inputSearch">
							<div class="input-group-append">
								<button class="btn btn-outline-secondary" type="button" id="inputSearch"><i
										class="fa fa-search" aria-hidden="true"></i></button>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col">
						<table class="table table-bordered table-hover table-responsive-md text-center" id="requests_table">
							<thead class="thead-dark">
								<tr>
									<th>ID</th>
									<th>Budget Code</th>
									<th>Requester</th>
									<th>Status</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td colspan="4">Loading...</td>
								</tr>
							</tbody>
						</table>
						<button type="button" name="inputViewMore" id="inputViewMore"
												class="btn btn-primary btn-lg btn-block">View More</button>
					</div>
				</div>
			</div>
		</div>
	</main>

	<!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
		integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
		crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
		integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
		crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
		integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
		crossorigin="anonymous"></script>

	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script>
		function getCookie(cname){
			var name = cname + "=";
			var decodedCookie = decodeURIComponent(document.cookie);
			var ca = decodedCookie.split(';');
			for(var i = 0; i <ca.length; i++) {
				var c = ca[i];
				while (c.charAt(0) == ' '){
					c = c.substring(1);
				}

				if (c.indexOf(name) == 0) {
					return c.substring(name.length, c.length);
				}
			}
			return "";
		}

		/*function loadTable(tableId, fields, data) {
			var rows = '';
			$.each(data, function(index, item) {
				var row = '<tr>';
				$.each(fields, function(index, field) {
					row += '<td>' + item[field+''] + '</td>';
				});
				rows += row + '<tr>';
			});
			$('#' + tableId + ' tbody').html(rows);
		}*/

		var dynamicTable = (function() {

			var _tableId, _table,
					_fields, _headers,
					_defaultText;

			/** Builds the row with columns from the specified names.
			 *  If the item parameter is specified, the memebers of the names array will be used as property names of the item; otherwise they will be directly parsed as text.
			 */
			function _buildRowColumns(names, item) {
				var row = '<tr>';
				if (names && names.length > 0)
				{
					$.each(names, function(index, name) {
						var c = item ? item[name+''] : name;
						switch (c) {
							case "BEFORE_BUDGET_APPROVAL":
								c = '<span class="badge badge-primary badge-pill">Awaiting Budget Code Approval</span>';
								break;
							case "BEFORE_FINANCE_APPROVAL":
								c = '<strong><span class="badge badge-info badge-warning">Awaiting Finance Approval</span></strong>';
								break;
							case "BEFORE_REQ_APPROVAL":
								c = '<strong><span class="badge badge-info badge-pill">Awaiting Requisition Approval</span></strong>';
								break;
							case "DONE":
								c = '<strong><span class="badge badge-success badge-pill">Ordered</span></strong>';
								break;
							case "DENIED":
								c = '<strong><span class="badge badge-danger badge-pill">Denied</span></strong>';
								break;
						}
						row += '<td>' + c + '</td>';
					});
				}
				row += '</tr>';
				return row;
			}

			function _columnCount() {
				var colCount = 0;
				$('tr:nth-child(1) td').each(function () {
					if ($(this).attr('colspan')) {
						colCount += +$(this).attr('colspan');
					} else {
						colCount++;
					}
				});

				return colCount;
			}

			function _setNoItemsInfo() {
				if (_table.length < 1) return; //not configured.
				var colspan = 'colspan="' + _columnCount() + '"';
				var content = '<tr class="no-items"><td ' + colspan + ' style="text-align:center">' +
						_defaultText + '</td></tr>';
				if (_table.children('tbody').length > 0) {
					_table.children('tbody').html(content);
				} else {
					_table.append('<tbody>' + content + '</tbody>');
				}
			}

			function _removeNoItemsInfo() {
				var c = _table.children('tbody').children('tr');
				if (c.length == 1 && c.hasClass('no-items')) _table.children('tbody').empty();
			}

			return {
				/** Configres the dynamic table. */
				config: function(tableId, fields, headers, defaultText) {
					_tableId = tableId;
					_table = $('#' + tableId);
					_fields = fields || null;
					_headers = headers || null;
					_defaultText = defaultText || 'No items to list...';
					_setNoItemsInfo();
					return this;
				},
				/** Loads the specified data to the table body. */
				load: function(data, append) {
					if (_table.length < 1) return; //not configured.
					_removeNoItemsInfo();
					if (data && data.length > 0) {
						var rows = '';
						$.each(data, function(index, item) {
							rows += _buildRowColumns(_fields, item);
						});
						var mthd = append ? 'append' : 'html';
						_table.children('tbody')[mthd](rows);
					} else {
						_setNoItemsInfo();
					}
					return this;
				},
				/** Clears the table body. */
				clear: function() {
					_setNoItemsInfo();
					return this;
				}
			};
		}());

		function search() {
			var value = $("#search").val();

			$("table#requests_table tbody tr").each(function(index) {
				$row = $(this);
				let showRow = false;

				$row.find('td').each(function() {
					var id = $(this).text();

					if (id.indexOf(value) == 0) {
						showRow = true;
					}
				});

				if (showRow) {
					$row.show();
				} else {
					$row.hide();
				}
			});
		}

		const jwt = getCookie('jwt');
		$.post("api/validate_token.php", JSON.stringify({ jwt:jwt })).done(function(result) {
			$.ajax({
				type : "POST",
				url : "api/requests.php",
				contentType : 'application/json',
				data : JSON.stringify(jwt),
				success : function(rows) {
					const numRows = rows.length;
					$('#pending_requests').html(numRows);

					var count = 0;
					const dt = dynamicTable.config('requests_table',
							['procurementId', 'budgetCode', 'requesterId', 'status'], null, 'No requests');
					for (var i = 0; i < 5; i++) {
						dt.load([rows[count++]], true);
					}
					const viewMore = $('#inputViewMore');
					viewMore.click(function() {
						for (var i = 0; i < 5; i++) {
							if (count < numRows) {
								dt.load([rows[count++]], true);
							}
						}
						search();
						$('#inputViewMore').html("View More (" + count + "/" + numRows + ")");
					});
					viewMore.html("View More (" + count + "/" + numRows + ")");
				},
				error: function(xhr, resp, text) {
					// do something here
				}
			});
		}).fail(function (result) {
			location.href = "login.html";
		});

		$("#search").on("keyup", function() {
			search();
		});

		function setCookie(cname, cvalue, exdays) {
			const d = new Date();
			d.setTime(d.getTime() + (exdays*24*60*60*1000));
			const expires = "expires="+ d.toUTCString();
			document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
		}

		$(document).on('submit', '#do_logout', function() {
			setCookie("jwt", "", 1);
			location.href = "login.html";

			return false; //Need to allow redirect
		});
	</script>

</body>

</html>
